---
import { format } from "date-fns";
import Base from "../../layouts/Base.astro";
import { getAllEpisodes, getEpisodeBySlug, getEpisodeNeighbors } from "../../data";

export function getStaticPaths() {
  return getAllEpisodes().map((ep) => ({
    params: { slug: ep.slug },
  }));
}

const { slug } = Astro.params;
const episode = getEpisodeBySlug(slug!);

if (!episode) {
  return Astro.redirect("/episodes/");
}

const date = format(new Date(episode.createdAt), "MMMM d, yyyy");
const hosts = episode.people.filter((p) => p.role === "host");
const guests = episode.people.filter((p) => p.role === "guest");
const { prev, next } = getEpisodeNeighbors(slug!);
---

<Base title={episode.formattedTitle} description={episode.description} ogType="article">
  <article class="max-w-3xl">
    <header class="mb-8">
      <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-stone-400 mb-2">
        <a
          href={`/series/${episode.seriesSlug}/`}
          class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300"
        >
          {episode.seriesName}
        </a>
        <span>&middot;</span>
        <span>#{episode.number}</span>
        <span>&middot;</span>
        <time datetime={episode.createdAt}>{date}</time>
      </div>
      <h1 class="text-3xl font-bold">{episode.name}</h1>
      {episode.description && (
        <p class="mt-3 text-gray-600 dark:text-stone-300 text-lg">{episode.description}</p>
      )}
    </header>

    {episode.media && (
      <div class="mb-8 p-4 bg-gray-50 dark:bg-stone-900 border border-gray-200 dark:border-stone-700 rounded-lg shadow-sm">
        <audio controls preload="none" class="w-full">
          <source src={episode.media.url} type="audio/mpeg" />
        </audio>
        <div class="mt-2 text-xs text-gray-500 dark:text-stone-400 flex gap-4">
          <span>Duration: {episode.media.length}</span>
          <span>
            Size: {(parseInt(episode.media.size) / 1_048_576).toFixed(1)} MB
          </span>
          <a
            href={episode.media.url}
            class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300"
            download
          >
            Download MP3
          </a>
        </div>
      </div>
    )}

    <div class="flex flex-wrap gap-4 mb-8 text-sm">
      {hosts.length > 0 && (
        <div>
          <span class="text-gray-500 dark:text-stone-400">Hosts:</span>{" "}
          {hosts.map((p, i) => (
            <>
              {i > 0 && ", "}
              <a
                href={`/people/${p.slug}/`}
                class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300"
              >
                {p.name}
              </a>
            </>
          ))}
        </div>
      )}
      {guests.length > 0 && (
        <div>
          <span class="text-gray-500 dark:text-stone-400">Guests:</span>{" "}
          {guests.map((p, i) => (
            <>
              {i > 0 && ", "}
              <a
                href={`/people/${p.slug}/`}
                class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300"
              >
                {p.name}
              </a>
            </>
          ))}
        </div>
      )}
    </div>

    {(episode.fringeSlug || episode.parentSlug) && (
      <div class="mb-8 p-3 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded text-sm">
        {episode.fringeSlug && (
          <p>
            <span class="text-gray-600 dark:text-stone-300">Fringe episode:</span>{" "}
            <a
              href={`/episodes/${episode.fringeSlug}/`}
              class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300"
            >
              {episode.fringeSlug}
            </a>
          </p>
        )}
        {episode.parentSlug && (
          <p>
            <span class="text-gray-600 dark:text-stone-300">Main episode:</span>{" "}
            <a
              href={`/episodes/${episode.parentSlug}/`}
              class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300"
            >
              {episode.parentSlug}
            </a>
          </p>
        )}
      </div>
    )}

    <div class="prose prose-gray dark:prose-invert max-w-none" set:html={episode.content} />

    {(prev || next) && (
      <nav class="mt-12 pt-6 border-t border-gray-200 dark:border-stone-800 flex justify-between items-start gap-4">
        {prev ? (
          <a
            href={`/episodes/${prev.slug}/`}
            class="group flex flex-col text-sm"
          >
            <span class="text-gray-400 dark:text-stone-500 text-xs">&larr; Older</span>
            <span class="text-blue-600 dark:text-blue-400 group-hover:text-blue-800 dark:group-hover:text-blue-300">
              #{prev.number}: {prev.name}
            </span>
          </a>
        ) : (
          <div />
        )}
        {next ? (
          <a
            href={`/episodes/${next.slug}/`}
            class="group flex flex-col text-sm text-right"
          >
            <span class="text-gray-400 dark:text-stone-500 text-xs">Newer &rarr;</span>
            <span class="text-blue-600 dark:text-blue-400 group-hover:text-blue-800 dark:group-hover:text-blue-300">
              #{next.number}: {next.name}
            </span>
          </a>
        ) : (
          <div />
        )}
      </nav>
    )}
  </article>
</Base>
