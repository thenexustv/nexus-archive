---
import { format } from "date-fns";
import Base from "../../layouts/Base.astro";
import EpisodeCard from "../../components/EpisodeCard.astro";
import Pagination from "../../components/Pagination.astro";
import { getAllSeries, getEpisodesBySeries, EPISODES_PER_PAGE } from "../../data";

export function getStaticPaths() {
  const allSeries = getAllSeries();
  const paths: { params: { slug: string }; props: Record<string, unknown> }[] = [];

  for (const series of allSeries) {
    const episodes = getEpisodesBySeries(series.slug);
    const totalPages = Math.ceil(episodes.length / EPISODES_PER_PAGE);

    for (let i = 0; i < totalPages; i++) {
      const page = i + 1;
      const start = i * EPISODES_PER_PAGE;
      const pageEpisodes = episodes.slice(start, start + EPISODES_PER_PAGE);

      paths.push({
        params: { slug: page === 1 ? series.slug : `${series.slug}/${page}` },
        props: {
          series,
          episodes: pageEpisodes,
          currentPage: page,
          totalPages,
        },
      });
    }
  }

  return paths;
}

interface Props {
  series: ReturnType<typeof import("../../data").getSeriesBySlug>;
  episodes: ReturnType<typeof import("../../data").getEpisodesBySeries>;
  currentPage: number;
  totalPages: number;
}

const { series, episodes, currentPage, totalPages } = Astro.props;

if (!series) {
  return Astro.redirect("/series/");
}

const firstYear = series.firstEpisodeDate
  ? format(new Date(series.firstEpisodeDate), "yyyy")
  : null;
const lastYear = series.lastEpisodeDate
  ? format(new Date(series.lastEpisodeDate), "yyyy")
  : null;
const dateRange =
  firstYear && lastYear
    ? firstYear === lastYear
      ? firstYear
      : `${firstYear}–${lastYear}`
    : null;
---

<Base
  title={currentPage > 1 ? `${series.name} (Page ${currentPage})` : series.name}
  description={series.description}
  feeds={[
    { title: `${series.name} RSS Feed`, url: `/series/${series.slug}/feed.xml` },
    { title: `${series.name} (with Fringe) RSS Feed`, url: `/series/${series.slug}/feed-fringe.xml` },
  ]}
>
  <div class="flex items-center gap-3 mb-1">
    <h1 class="text-2xl font-bold">{series.name}</h1>
    <span class="text-xs px-1.5 py-0.5 bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-200 rounded font-medium">
      Archived
    </span>
    <a href={`/series/${series.slug}/feed.xml`} class="text-xs text-gray-500 dark:text-stone-400 hover:text-gray-700 dark:hover:text-stone-300">Feed</a>
    <a href={`/series/${series.slug}/feed-fringe.xml`} class="text-xs text-gray-500 dark:text-stone-400 hover:text-gray-700 dark:hover:text-stone-300">Feed + Fringe</a>
    {series.itunesUrl && (
      <a href={series.itunesUrl} class="text-xs text-gray-500 dark:text-stone-400 hover:text-gray-700 dark:hover:text-stone-300" target="_blank" rel="noopener noreferrer">iTunes</a>
    )}
  </div>
  {series.description && (
    <p class="text-gray-600 dark:text-stone-300 mb-2">{series.description}</p>
  )}
  <p class="text-sm text-gray-500 dark:text-stone-400 mb-6">
    {series.episodeCount} episode{series.episodeCount !== 1 ? "s" : ""}
    {dateRange && <span> &middot; {dateRange}</span>}
    {totalPages > 1 && ` · Page ${currentPage} of ${totalPages}`}
  </p>

  <div class="divide-y divide-gray-100 dark:divide-stone-800">
    {episodes.map((ep) => <EpisodeCard episode={ep} />)}
  </div>

  <Pagination currentPage={currentPage} totalPages={totalPages} baseUrl={`/series/${series.slug}`} />
</Base>
