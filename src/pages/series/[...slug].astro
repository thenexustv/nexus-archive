---
import { format } from "date-fns";
import Base from "../../layouts/Base.astro";
import EpisodeCard from "../../components/EpisodeCard.astro";
import Pagination from "../../components/Pagination.astro";
import { getAllSeries, getEpisodesBySeries, EPISODES_PER_PAGE } from "../../data";

export function getStaticPaths() {
  const allSeries = getAllSeries();
  const paths: { params: { slug: string }; props: Record<string, unknown> }[] = [];

  for (const series of allSeries) {
    const episodes = getEpisodesBySeries(series.slug);
    const totalPages = Math.ceil(episodes.length / EPISODES_PER_PAGE);

    for (let i = 0; i < totalPages; i++) {
      const page = i + 1;
      const start = i * EPISODES_PER_PAGE;
      const pageEpisodes = episodes.slice(start, start + EPISODES_PER_PAGE);

      paths.push({
        params: { slug: page === 1 ? series.slug : `${series.slug}/${page}` },
        props: {
          series,
          episodes: pageEpisodes,
          currentPage: page,
          totalPages,
        },
      });
    }
  }

  return paths;
}

interface Props {
  series: ReturnType<typeof import("../../data").getSeriesBySlug>;
  episodes: ReturnType<typeof import("../../data").getEpisodesBySeries>;
  currentPage: number;
  totalPages: number;
}

const { series, episodes, currentPage, totalPages } = Astro.props;

if (!series) {
  return Astro.redirect("/series/");
}

const firstYear = series.firstEpisodeDate
  ? format(new Date(series.firstEpisodeDate), "yyyy")
  : null;
const lastYear = series.lastEpisodeDate
  ? format(new Date(series.lastEpisodeDate), "yyyy")
  : null;
const dateRange =
  firstYear && lastYear
    ? firstYear === lastYear
      ? firstYear
      : `${firstYear}–${lastYear}`
    : null;
---

<Base
  title={currentPage > 1 ? `${series.name} (Page ${currentPage})` : series.name}
  description={series.description}
  feeds={[
    { title: `${series.name} RSS Feed`, url: `/series/${series.slug}/feed.xml` },
    { title: `${series.name} (with Fringe) RSS Feed`, url: `/series/${series.slug}/feed-fringe.xml` },
  ]}
>
  <div class="flex items-center gap-3 mb-1">
    <h1 class="text-2xl font-bold">{series.name}</h1>
    <span class="text-xs px-1.5 py-0.5 bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-200 rounded font-medium">
      Archived
    </span>
    <a href={`/series/${series.slug}/feed.xml`} class="inline-flex items-center gap-1 text-xs text-gray-400 dark:text-stone-500 hover:text-orange-600 dark:hover:text-orange-400 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3.5 h-3.5">
        <path d="M3.75 3a.75.75 0 0 0-.75.75v.5c0 .414.336.75.75.75H4c6.075 0 11 4.925 11 11v.25c0 .414.336.75.75.75h.5a.75.75 0 0 0 .75-.75V16C17 8.82 11.18 3 4 3h-.25Z"/>
        <path d="M3 8.75A.75.75 0 0 1 3.75 8H4a8 8 0 0 1 8 8v.25a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1-.75-.75V16a6 6 0 0 0-6-6h-.25A.75.75 0 0 1 3 9.25v-.5ZM7 15a2 2 0 1 1-4 0 2 2 0 0 1 4 0Z"/>
      </svg>
      Feed
    </a>
    <a href={`/series/${series.slug}/feed-fringe.xml`} class="inline-flex items-center gap-1 text-xs text-gray-400 dark:text-stone-500 hover:text-orange-600 dark:hover:text-orange-400 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3.5 h-3.5">
        <path d="M3.75 3a.75.75 0 0 0-.75.75v.5c0 .414.336.75.75.75H4c6.075 0 11 4.925 11 11v.25c0 .414.336.75.75.75h.5a.75.75 0 0 0 .75-.75V16C17 8.82 11.18 3 4 3h-.25Z"/>
        <path d="M3 8.75A.75.75 0 0 1 3.75 8H4a8 8 0 0 1 8 8v.25a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1-.75-.75V16a6 6 0 0 0-6-6h-.25A.75.75 0 0 1 3 9.25v-.5ZM7 15a2 2 0 1 1-4 0 2 2 0 0 1 4 0Z"/>
      </svg>
      Feed + Fringe
    </a>
    {series.itunesUrl && (
      <a href={series.itunesUrl} class="inline-flex items-center gap-1 text-xs text-gray-400 dark:text-stone-500 hover:text-purple-600 dark:hover:text-purple-400 transition-colors" target="_blank" rel="noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-3.5 h-3.5">
          <path d="M6.22 8.72a.75.75 0 0 0 1.06 1.06l5.22-5.22v1.69a.75.75 0 0 0 1.5 0v-3.5a.75.75 0 0 0-.75-.75h-3.5a.75.75 0 0 0 0 1.5h1.69L6.22 8.72Z"/>
          <path d="M3.5 6.75c0-.69.56-1.25 1.25-1.25H7A.75.75 0 0 0 7 4H4.75A2.75 2.75 0 0 0 2 6.75v4.5A2.75 2.75 0 0 0 4.75 14h4.5A2.75 2.75 0 0 0 12 11.25V9a.75.75 0 0 0-1.5 0v2.25c0 .69-.56 1.25-1.25 1.25h-4.5c-.69 0-1.25-.56-1.25-1.25v-4.5Z"/>
        </svg>
        iTunes
      </a>
    )}
  </div>
  {series.description && (
    <p class="text-gray-600 dark:text-stone-300 mb-2">{series.description}</p>
  )}
  <p class="text-sm text-gray-500 dark:text-stone-400 mb-6">
    {series.episodeCount} episode{series.episodeCount !== 1 ? "s" : ""}
    {dateRange && <span> &middot; {dateRange}</span>}
    {totalPages > 1 && ` · Page ${currentPage} of ${totalPages}`}
  </p>

  <div class="divide-y divide-gray-100 dark:divide-stone-800">
    {episodes.map((ep) => <EpisodeCard episode={ep} />)}
  </div>

  <Pagination currentPage={currentPage} totalPages={totalPages} baseUrl={`/series/${series.slug}`} />
</Base>
